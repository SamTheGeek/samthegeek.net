import { promises as fs } from 'node:fs';
import path from 'node:path';

const galleriesDir = path.resolve('src/content/galleries');
const redirectsPath = path.resolve('public/_redirects');
const extraRedirectsPath = path.resolve('scripts/redirects.json');

const entries = await fs.readdir(galleriesDir, { withFileTypes: true });
const galleries = [];

for (const entry of entries) {
  if (!entry.isFile() || !entry.name.endsWith('.json')) {
    continue;
  }

  const filePath = path.join(galleriesDir, entry.name);
  const raw = await fs.readFile(filePath, 'utf8');
  const data = JSON.parse(raw);
  const slug = path.basename(entry.name, '.json');
  const publishedDate = new Date(data.publishedDate);

  if (Number.isNaN(publishedDate.valueOf())) {
    throw new Error(`Invalid publishedDate in ${entry.name}`);
  }

  galleries.push({ slug, publishedDate });
}

if (galleries.length === 0) {
  throw new Error('No gallery JSON files found.');
}

galleries.sort((a, b) => b.publishedDate.valueOf() - a.publishedDate.valueOf());
const newest = galleries[0];

const legacyRedirects = [
  { from: '/los-angeles19', to: '/los-angeles' },
  { from: '/france18', to: '/france' },
  { from: '/japan18', to: '/japan' },
  { from: '/canada17', to: '/canada' },
];

let extraRedirects = [];
try {
  const raw = await fs.readFile(extraRedirectsPath, 'utf8');
  extraRedirects = JSON.parse(raw);
} catch (error) {
  extraRedirects = [];
}

const redirectsContent = [
  '# Auto-generated by scripts/generate-latest-redirect.mjs',
  `/ /${newest.slug} 302`,
  ...legacyRedirects.map((redirect) => `${redirect.from} ${redirect.to} 301`),
  ...extraRedirects.map((redirect) => `${redirect.from} ${redirect.to} ${redirect.status ?? 301}`),
  '',
].join('\n');

await fs.writeFile(redirectsPath, redirectsContent, 'utf8');
