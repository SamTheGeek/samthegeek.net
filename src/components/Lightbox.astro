---
// Lightbox component for full-size image viewing
---

<div id="lightbox" class="lightbox">
  <div class="lightbox-controls" role="group" aria-label="Lightbox controls">
    <div class="lightbox-controls-row">
      <button class="lightbox-info-toggle" type="button" aria-label="Show photo info" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle class="info-ring" cx="12" cy="12" r="9" />
          <path d="M12 11v6" />
          <circle class="info-dot" cx="12" cy="7.5" r="1.4" />
        </svg>
      </button>
      <button class="lightbox-close" type="button" aria-label="Close lightbox">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M5 5 19 19M19 5 5 19" />
        </svg>
      </button>
    </div>
    <div class="lightbox-info" id="lightbox-info" aria-live="polite">
      <div class="lightbox-info-card">
        <div class="lightbox-info-header" id="lightbox-info-header">
          <div class="lightbox-info-date-label">Date</div>
          <div class="lightbox-info-date" id="lightbox-date"></div>
          <div class="lightbox-info-location" id="lightbox-location"></div>
        </div>
        <div class="lightbox-info-section" data-field="camera">
          <div class="lightbox-info-label">Camera</div>
          <div class="lightbox-info-value" id="lightbox-camera"></div>
        </div>
        <div class="lightbox-info-section" data-field="lens">
          <div class="lightbox-info-label">Lens</div>
          <div class="lightbox-info-value" id="lightbox-lens"></div>
        </div>
        <div class="lightbox-info-section" data-field="settings">
          <div class="lightbox-info-label">Settings</div>
          <div class="lightbox-info-value" id="lightbox-settings"></div>
        </div>
        <div class="lightbox-info-section lightbox-map-section is-empty" id="lightbox-map-section" data-field="map">
          <div class="lightbox-info-label" id="lightbox-map-label">Location</div>
          <div class="lightbox-map" id="lightbox-map">
            <div class="lightbox-map-frame" id="lightbox-map-frame"></div>
            <a class="lightbox-map-link" id="lightbox-map-link" target="_blank" rel="noopener noreferrer" aria-label="Open location in Google Maps"></a>
          </div>
        </div>
        <div class="lightbox-info-empty" id="lightbox-empty">No photo details available.</div>
      </div>
    </div>
  </div>
  <div class="lightbox-content">
    <picture class="lightbox-picture">
      <source id="lightbox-source" type="image/webp" srcset="" />
      <img id="lightbox-image" class="lightbox-image" src="" alt="" />
    </picture>
  </div>
</div>

<style>
  .lightbox {
    display: flex;
    position: fixed;
    z-index: 9999;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    justify-content: center;
    align-items: center;
    opacity: 1;
    visibility: hidden;
    pointer-events: none;
    --zoom-duration: 900ms;
    --fade-duration: 765ms;
    --fade-delay-open: calc(var(--zoom-duration) - var(--fade-duration));
  }

  .lightbox.active {
    visibility: visible;
    pointer-events: auto;
  }

  .lightbox.is-closing {
    visibility: visible;
    pointer-events: none;
  }

  .lightbox::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 50% 45%, rgba(35, 35, 35, 0.45) 0%, rgba(0, 0, 0, 0.86) 72%, rgba(0, 0, 0, 0.92) 100%);
    opacity: 0;
    transition: opacity var(--fade-duration) ease;
  }

  .lightbox.active::before {
    opacity: 1;
    transition-delay: var(--fade-delay-open);
  }

  .lightbox.is-closing::before {
    opacity: 0;
    transition-delay: 0s;
  }

  .lightbox-content {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 2rem;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .lightbox-picture {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
  }

  .lightbox-image {
    position: absolute;
    inset: 0;
    max-width: min(100%, 1400px);
    max-height: min(90vh, 860px);
    object-fit: contain;
    border-radius: 0;
    box-shadow: 0 20px 70px rgba(0, 0, 0, 0.45), 0 0 0 1px rgba(255, 255, 255, 0.08);
    margin: auto;
    opacity: 1;
    transform: translateZ(0);
    transition: transform var(--zoom-duration) cubic-bezier(0.22, 1, 0.36, 1);
    will-change: transform, opacity;
    pointer-events: auto;
  }

  .lightbox-image.is-loading {
    animation: lightbox-pulse 0.9s ease-in-out infinite;
  }

  @keyframes lightbox-pulse {
    0% {
      filter: brightness(0.96);
    }
    50% {
      filter: brightness(0.86);
    }
    100% {
      filter: brightness(0.96);
    }
  }

  .lightbox.is-loaded .lightbox-image {
    transform: translateZ(0) scale(1);
  }

  .lightbox-controls {
    position: absolute;
    top: 20px;
    right: 22px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.45rem;
    padding-top: var(--pill-height);
    width: var(--pill-width);
    max-height: var(--pill-height);
    isolation: isolate;
    box-sizing: border-box;
    z-index: 10000;
    overflow: hidden;
    border-radius: var(--pill-radius);
    background: rgba(18, 18, 18, 0.78);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    backdrop-filter: blur(10px);
    --pill-width: 5rem;
    --pill-height: 2.2rem;
    --pill-radius: calc(var(--pill-height) / 2);
    --info-max-width: min(70vw, 360px);
    transition: width var(--zoom-duration) cubic-bezier(0.22, 1, 0.36, 1),
      padding var(--zoom-duration) cubic-bezier(0.22, 1, 0.36, 1),
      max-height var(--zoom-duration) cubic-bezier(0.22, 1, 0.36, 1),
      transform var(--zoom-duration) cubic-bezier(0.22, 1, 0.36, 1),
      opacity var(--fade-duration) ease,
      background var(--zoom-duration) ease;
    opacity: 0;
    transform: translate3d(0, -6px, 0);
    will-change: transform, opacity;
  }

  .lightbox.active .lightbox-controls {
    opacity: 1;
    transform: translate3d(0, 0, 0);
    transition-delay: var(--fade-delay-open);
  }

  .lightbox.is-closing .lightbox-controls {
    opacity: 0;
    transition-delay: 0s;
  }

  .lightbox-controls-row {
    position: absolute;
    top: 0;
    right: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    justify-items: center;
    min-height: var(--pill-height);
    width: var(--pill-width);
    z-index: 3;
  }

  .lightbox-controls-row::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    width: 1px;
    height: 0.9rem;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  .lightbox-info {
    position: static;
    width: 100%;
    min-width: 220px;
    color: #f5f5f5;
    overflow: hidden;
    pointer-events: none;
    transform: none;
    max-height: 0;
    transition: max-height var(--zoom-duration) cubic-bezier(0.22, 1, 0.36, 1);
    will-change: max-height;
    z-index: 1;
  }

  .lightbox-info.active {
    pointer-events: auto;
    max-height: 80vh;
  }

  .lightbox-controls.expanded .lightbox-info {
    padding-right: 0.2rem;
  }

  .lightbox-controls.expanded.scroll-ready .lightbox-info {
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  .lightbox-controls.expanded .lightbox-info::-webkit-scrollbar {
    width: 6px;
  }

  .lightbox-controls.expanded .lightbox-info::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 999px;
  }

  .lightbox-info-card {
    width: 100%;
    padding: 0.6rem;
  }

  .lightbox-info-header {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    margin-bottom: 0.35rem;
  }

  .lightbox-info-date-label {
    font-size: 0.66rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.45);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .lightbox-info-date {
    font-size: 0.86rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.9);
    letter-spacing: 0.01em;
  }

  .lightbox-info-location {
    font-size: 0.72rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.55);
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .lightbox-info-section {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    padding: 0.45rem 0;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  .lightbox-info-label {
    font-size: 0.68rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.4);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .lightbox-info-value {
    font-size: 0.85rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.84);
    letter-spacing: 0.015em;
  }

  .lightbox-info-section[data-field="settings"] .lightbox-info-value {
    font-family: "Menlo", "Consolas", "Liberation Mono", monospace;
    font-size: 0.82rem;
    font-weight: 400;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .lightbox-map {
    width: 100%;
    height: 160px;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.08);
    position: relative;
  }

  .lightbox-map-frame,
  .lightbox-map-frame img {
    width: 100%;
    height: 100%;
  }

  .lightbox-map-frame {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .lightbox-map-frame img {
    display: block;
    object-fit: cover;
  }

  .lightbox-map-link {
    position: absolute;
    inset: 0;
    z-index: 2;
    cursor: pointer;
  }

  .lightbox-info-empty {
    display: none;
    font-size: 0.78rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.55);
    padding-top: 0.45rem;
  }

  .lightbox-info-empty.active {
    display: block;
  }

  .lightbox-info-section.is-empty {
    display: none;
  }

  .lightbox-map-section {
    padding-bottom: 0;
  }

  .lightbox-controls button {
    background: transparent;
    border: none;
    color: #f1f1f1;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
    height: var(--pill-height);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    transition: opacity 0.2s ease;
  }

  .lightbox-controls button:hover {
    opacity: 0.7;
  }

  .lightbox-controls button svg {
    width: 1rem;
    height: 1rem;
    stroke: currentColor;
    stroke-width: 1.7;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
    display: block;
    align-self: center;
    justify-self: center;
    overflow: visible;
  }

  .lightbox-controls button svg .info-ring {
    fill: none;
  }

  .lightbox-controls button svg .info-dot {
    fill: currentColor;
    stroke: none;
  }


  .lightbox-info-toggle.active {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 999px;
  }

  .lightbox-info-toggle {
    font-size: 0.85rem;
  }

  .lightbox-controls.expanded {
    padding: 0.6rem;
    width: var(--info-max-width);
    max-height: 80vh;
  }

  .lightbox-controls.expanded::before {
    width: 100%;
    height: 100%;
  }


  @media (max-width: 768px) {
    .lightbox-controls {
      top: 10px;
      right: 10px;
    }

    .lightbox-controls.expanded {
      width: min(var(--info-max-width), calc(100vw - 32px));
      max-width: var(--info-max-width);
    }

    .lightbox-info {
      max-width: 100%;
      min-width: 0;
    }

    .lightbox-content {
      padding: 1rem;
    }
  }
</style>

<script>
  // Lightbox functionality
  function initLightbox() {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxSource = document.getElementById('lightbox-source') as HTMLSourceElement | null;
    const lightboxDate = document.getElementById('lightbox-date');
    const lightboxHeader = document.getElementById('lightbox-info-header');
    const lightboxLocation = document.getElementById('lightbox-location');
    const lightboxCamera = document.getElementById('lightbox-camera');
    const lightboxLens = document.getElementById('lightbox-lens');
    const lightboxSettings = document.getElementById('lightbox-settings');
    const lightboxMap = document.getElementById('lightbox-map');
    const lightboxMapFrame = document.getElementById('lightbox-map-frame');
    const lightboxMapSection = document.getElementById('lightbox-map-section');
    const lightboxMapLabel = document.getElementById('lightbox-map-label');
    const lightboxMapLink = document.getElementById('lightbox-map-link') as HTMLAnchorElement | null;
    const lightboxEmpty = document.getElementById('lightbox-empty');
    const closeBtn = document.querySelector('.lightbox-close');
    const infoToggle = document.querySelector('.lightbox-info-toggle') as HTMLButtonElement | null;
    const infoBox = document.getElementById('lightbox-info');
    const controls = document.querySelector('.lightbox-controls');
    const lightboxContent = document.querySelector('.lightbox-content');
    const zoomDurationMs = 900;
    const openDelayMs = 60;
    let imageResizeObserver: ResizeObserver | null = null;
    let loadToken = 0;
    let activeImage: HTMLImageElement | null = null;
    let lastHiddenImage: HTMLImageElement | null = null;
    let isClosing = false;
    let closeTimeout: number | null = null;
    let isAnimatingOpen = false;
    let openAnimationTimeout: number | null = null;
    let pendingPreviewResize = false;
    let openStartTimeout: number | null = null;
    let bodyPaddingRight = '';
    let warmedLayout = false;
    let sizingDimensions: { width: number; height: number } | null = null;
    let infoScrollTimeout: number | null = null;
    const mapsKey = import.meta.env.PUBLIC_GOOGLE_MAPS_EMBED_API_KEY;
    const staticMapsKey = import.meta.env.PUBLIC_GOOGLE_MAPS_STATIC_API_KEY || mapsKey;

    // Get all gallery images
    const galleryImages = Array.from(document.querySelectorAll('.gallery-item img'));

    // Add click event to each gallery image
    galleryImages.forEach((img) => {
      img.addEventListener('click', () => {
        openLightbox(img as HTMLImageElement);
      });
    });

    // Close lightbox
    closeBtn?.addEventListener('click', closeLightbox);
    lightbox?.addEventListener('click', (e) => {
      if (!lightboxContent) return;
      if (lightboxContent.contains(e.target as Node)) return;
      if (controls?.contains(e.target as Node)) return;
      closeLightbox();
    });

    // Info toggle
    infoToggle?.addEventListener('click', () => {
      if (!infoBox) return;
      if (!infoBox.classList.contains('active')) {
        updateInfoWidth();
      }
      const isOpen = infoBox.classList.toggle('active');
      controls?.classList.toggle('expanded', isOpen);
      controls?.classList.remove('scroll-ready');
      if (infoScrollTimeout) {
        window.clearTimeout(infoScrollTimeout);
        infoScrollTimeout = null;
      }
      if (isOpen && controls) {
        infoScrollTimeout = window.setTimeout(() => {
          controls.classList.add('scroll-ready');
          infoScrollTimeout = null;
        }, zoomDurationMs);
      }
      infoToggle.classList.toggle('active', isOpen);
      infoToggle.setAttribute('aria-pressed', String(isOpen));
      infoToggle.setAttribute('aria-label', isOpen ? 'Hide photo info' : 'Show photo info');
      if (isOpen) scheduleInfoWidthUpdates();
    });

    // Keyboard navigation - ESC only
    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('active')) return;
      if (e.key === 'Escape') closeLightbox();
    });

    window.addEventListener('resize', () => {
      updateInfoWidth();
      updatePreviewSizing();
    });

    window.addEventListener('load', warmLayout);

    window.addEventListener('popstate', () => {
      const target = findImageFromUrl();
      if (target) {
        openLightbox(target);
        return;
      }
      if (lightbox?.classList.contains('active')) {
        closeLightbox();
      }
    });

    openFromUrlParam();

    warmLayout();

    function warmLayout() {
      if (warmedLayout || !lightbox || !lightboxImage) return;
      const previewVisibility = lightbox.style.visibility;
      const previewPointer = lightbox.style.pointerEvents;
      lightbox.classList.add('active');
      lightbox.style.visibility = 'hidden';
      lightbox.style.pointerEvents = 'none';
      updatePreviewSizing();
      lightbox.getBoundingClientRect();
      lightboxContent?.getBoundingClientRect();
      lightboxImage.getBoundingClientRect();
      lightbox.classList.remove('active');
      lightbox.style.visibility = previewVisibility;
      lightbox.style.pointerEvents = previewPointer;
      warmedLayout = true;
    }

    function openLightbox(img: HTMLImageElement) {
      if (!lightbox || !lightboxImage) return;

      if (closeTimeout) {
        window.clearTimeout(closeTimeout);
        closeTimeout = null;
      }
      if (openAnimationTimeout) {
        window.clearTimeout(openAnimationTimeout);
        openAnimationTimeout = null;
      }
      if (openStartTimeout) {
        window.clearTimeout(openStartTimeout);
        openStartTimeout = null;
      }
      isClosing = false;
      lightbox.classList.remove('is-closing');
      loadToken += 1;
      if (activeImage && activeImage !== img) {
        showSourceImage(activeImage);
      }
      activeImage = img;
      lastHiddenImage = img;
      lightbox.classList.remove('is-loaded');
      lightboxImage.classList.add('is-loading');
      lightboxSource?.removeAttribute('srcset');
      lightboxImage.removeAttribute('src');
      lightboxImage.alt = img.alt;
      sizingDimensions = null;
      hydrateInfo(img);
      setPhotoParam(img);
      infoBox?.classList.remove('active');
      controls?.classList.remove('expanded');
      controls?.classList.remove('scroll-ready');
      if (infoScrollTimeout) {
        window.clearTimeout(infoScrollTimeout);
        infoScrollTimeout = null;
      }
      if (infoToggle) {
        infoToggle.classList.remove('active');
        infoToggle.setAttribute('aria-pressed', 'false');
        infoToggle.setAttribute('aria-label', 'Show photo info');
      }
      isAnimatingOpen = false;
      pendingPreviewResize = false;
      scheduleInfoWidthUpdates();
      if ('ResizeObserver' in window) {
        imageResizeObserver?.disconnect();
        imageResizeObserver = new ResizeObserver(() => updateInfoWidth());
        imageResizeObserver.observe(lightboxImage);
      }
      waitForImageReady(img, loadToken)
        .then((token) => {
          if (token !== loadToken) return;
          updatePreviewSizing();
          return loadFullImage(img, token);
        })
        .then((token) => {
          if (!token || token !== loadToken) return;
          lightboxImage.classList.remove('is-loading');
          if (lightboxImage.naturalWidth && lightboxImage.naturalHeight) {
            sizingDimensions = {
              width: lightboxImage.naturalWidth,
              height: lightboxImage.naturalHeight,
            };
            applyAspectRatioFromDimensions(sizingDimensions);
            updatePreviewSizing(sizingDimensions);
          }
          beginOpenAnimation(img, token);
        })
        .catch(() => undefined);
    }

    function closeLightbox() {
      if (!lightbox) return;

      if (isClosing) return;
      if (openAnimationTimeout) {
        window.clearTimeout(openAnimationTimeout);
        openAnimationTimeout = null;
      }
      if (openStartTimeout) {
        window.clearTimeout(openStartTimeout);
        openStartTimeout = null;
      }
      const target = activeImage;
      if (target && lightbox.classList.contains('active')) {
        isClosing = true;
        lightbox.classList.add('is-closing');
        animateToThumbnail(target);
        closeTimeout = window.setTimeout(() => {
          closeTimeout = null;
          finalizeClose();
        }, zoomDurationMs);
        return;
      }
      finalizeClose();
    }

    function finalizeClose() {
      if (!lightbox) return;
      loadToken += 1;
      lightbox.classList.remove('active');
      lightbox.classList.remove('is-loaded');
      lightbox.classList.remove('is-closing');
      lightbox.classList.remove('is-animating-open');
      isClosing = false;
      isAnimatingOpen = false;
      unlockScroll();
      clearPhotoParam();
      clearInfo();
      clearPreview();
      activeImage = null;
      sizingDimensions = null;
      lightboxImage?.classList.remove('is-loading');
      resetZoomTransform();
      if (lastHiddenImage) {
        showSourceImage(lastHiddenImage);
        lastHiddenImage = null;
      }
      infoBox?.classList.remove('active');
      controls?.classList.remove('expanded');
      controls?.classList.remove('scroll-ready');
      if (infoScrollTimeout) {
        window.clearTimeout(infoScrollTimeout);
        infoScrollTimeout = null;
      }
      if (infoToggle) {
        infoToggle.classList.remove('active');
        infoToggle.setAttribute('aria-pressed', 'false');
        infoToggle.setAttribute('aria-label', 'Show photo info');
      }
      imageResizeObserver?.disconnect();
    }

    function openFromUrlParam() {
      const target = findImageFromUrl();
      if (target) {
        openLightbox(target);
      }
    }

    function findImageFromUrl() {
      const value = getPhotoParam();
      if (!value) return null;
      const decodedValue = decodeURIComponent(value);
      for (const img of galleryImages) {
        const path = new URL(img.src).pathname;
        const filename = decodeURIComponent(path.split('/').pop() || '');
        if (filename === value || filename === decodedValue) return img as HTMLImageElement;
      }
      return null;
    }

    function getPhotoParam() {
      const url = new URL(window.location.href);
      return url.searchParams.get('photo');
    }

    function setPhotoParam(img: HTMLImageElement) {
      const url = new URL(window.location.href);
      const path = new URL(img.src).pathname;
      const filename = decodeURIComponent(path.split('/').pop() || '');
      url.searchParams.set('photo', filename);
      history.replaceState({}, '', url);
    }

    function clearPhotoParam() {
      const url = new URL(window.location.href);
      if (!url.searchParams.has('photo')) return;
      url.searchParams.delete('photo');
      history.replaceState({}, '', url);
    }

    function updateInfoWidth() {
      if (!controls || !lightbox || !lightboxImage) return;
      if (!lightbox.classList.contains('active')) return;
      const rect = lightboxImage.getBoundingClientRect();
      const naturalWidth = lightboxImage.naturalWidth;
      const naturalHeight = lightboxImage.naturalHeight;
      let displayWidth = rect.width;
      if (naturalWidth && naturalHeight && lightboxContent) {
        const contentRect = lightboxContent.getBoundingClientRect();
        const scale = Math.min(
          contentRect.width / naturalWidth,
          contentRect.height / naturalHeight,
          1
        );
        displayWidth = naturalWidth * scale;
      }
      if (!displayWidth) return;
      const maxWidth = Math.min(displayWidth, window.innerWidth * 0.7, 360);
      const minWidth = 180;
      const clamped = Math.max(minWidth, Math.floor(maxWidth));
      const finalWidth = Math.min(clamped, displayWidth);
      controls.style.setProperty('--info-max-width', `${Math.floor(finalWidth)}px`);
    }

    function scheduleInfoWidthUpdates() {
      updateInfoWidth();
      requestAnimationFrame(updateInfoWidth);
      setTimeout(updateInfoWidth, 120);
      setTimeout(updateInfoWidth, 300);
      if (lightboxImage?.decode) {
        lightboxImage.decode().then(updateInfoWidth).catch(() => undefined);
      }
      if (lightboxContent) {
        requestAnimationFrame(() => requestAnimationFrame(updateInfoWidth));
      }
    }

    function applyAspectRatio(img: HTMLImageElement) {
      if (!lightboxImage) return;
      const dimensions = getImageDimensions(img);
      if (!dimensions) return;
      applyAspectRatioFromDimensions(dimensions);
    }

    function applyAspectRatioFromDimensions(dimensions: { width: number; height: number }) {
      if (!lightboxImage) return;
      const ratio = `${dimensions.width} / ${dimensions.height}`;
      lightboxImage.style.aspectRatio = ratio;
    }

    function updatePreviewSizing(dimensionsOverride?: { width: number; height: number }) {
      if (isClosing || isAnimatingOpen) {
        pendingPreviewResize = true;
        return;
      }
      if (!activeImage || !lightboxImage || !lightboxContent) return;
      const dimensions =
        dimensionsOverride || sizingDimensions || getImageDimensions(activeImage);
      if (!dimensions) return;
      const targetRect = getTargetRect(dimensions);
      if (!targetRect) return;
      lightboxImage.style.width = `${Math.floor(targetRect.width)}px`;
      lightboxImage.style.height = `${Math.floor(targetRect.height)}px`;
    }

    function resetZoomTransform() {
      if (!lightboxImage) return;
      lightboxImage.style.transform = '';
      lightboxImage.style.transformOrigin = '';
    }

    function applyStartTransform(sourceRect: DOMRect, targetRect: DOMRect) {
      if (!lightboxImage) return false;
      const transform = calculateTransform(sourceRect, targetRect);
      if (!transform) return false;
      const previousTransition = lightboxImage.style.transition;
      lightboxImage.style.transformOrigin = 'top left';
      lightboxImage.style.transition = 'none';
      lightboxImage.style.transform = transform;
      lightboxImage.getBoundingClientRect();
      lightboxImage.style.transition = previousTransition;
      return true;
    }

    function playZoomToLightbox(token: number) {
      if (!lightboxImage) return;
      if (!lightbox?.classList.contains('active')) return;
      if (token !== loadToken) return;
      if (openStartTimeout) {
        window.clearTimeout(openStartTimeout);
      }
      openStartTimeout = window.setTimeout(() => {
        if (token !== loadToken) return;
        lightbox?.classList.add('is-loaded');
        startOpenAnimationTimer();
        requestAnimationFrame(() => {
          if (token !== loadToken) return;
          lightboxImage.style.transform = 'translateZ(0) scale(1)';
        });
      }, openDelayMs);
    }

    function startOpenAnimationTimer() {
      if (openAnimationTimeout) return;
      openAnimationTimeout = window.setTimeout(() => {
        isAnimatingOpen = false;
        lightbox?.classList.remove('is-animating-open');
        openAnimationTimeout = null;
        if (pendingPreviewResize) {
          pendingPreviewResize = false;
          updatePreviewSizing();
          updateInfoWidth();
        }
      }, zoomDurationMs);
    }

    function animateToThumbnail(img: HTMLImageElement) {
      if (!lightboxImage) return;
      const targetRect = img.getBoundingClientRect();
      const sourceDimensions =
        sizingDimensions || getImageDimensions(img) || getImageDimensions(activeImage);
      const sourceRect = sourceDimensions ? getTargetRect(sourceDimensions) : null;
      if (!sourceRect) return;
      const transform = calculateTransform(targetRect, sourceRect);
      if (!transform) return;
      lightboxImage.style.transformOrigin = 'top left';
      lightboxImage.style.transform = transform;
    }

    function beginOpenAnimation(img: HTMLImageElement, token: number) {
      if (!lightbox || !lightboxImage) return;
      if (token !== loadToken) return;
      if (!lightbox.classList.contains('active')) {
        lightbox.classList.add('active');
        lockScroll();
      }
      lightbox.getBoundingClientRect();
      lightboxContent?.getBoundingClientRect();
      const sourceRect = img.getBoundingClientRect();
      const targetDimensions =
        sizingDimensions || getImageDimensions(img) || getImageDimensions(activeImage);
      const targetRect = targetDimensions ? getTargetRect(targetDimensions) : null;
      hideSourceImage(activeImage);
      updatePreviewSizing();
      resetZoomTransform();
      const hasStartTransform =
        Boolean(targetRect) && applyStartTransform(sourceRect, targetRect);
      isAnimatingOpen = Boolean(hasStartTransform);
      lightbox.classList.toggle('is-animating-open', Boolean(hasStartTransform));
      lightbox.classList.remove('is-loaded');
      if (hasStartTransform) {
        playZoomToLightbox(token);
      } else {
        isAnimatingOpen = false;
        lightbox.classList.remove('is-animating-open');
      }
    }

    function calculateTransform(sourceRect: DOMRect, targetRect: DOMRect) {
      if (
        !sourceRect.width ||
        !sourceRect.height ||
        !targetRect.width ||
        !targetRect.height
      ) {
        return '';
      }
      const scaleX = sourceRect.width / targetRect.width;
      const scaleY = sourceRect.height / targetRect.height;
      const translateX = sourceRect.left - targetRect.left;
      const translateY = sourceRect.top - targetRect.top;
      return `translate3d(${translateX}px, ${translateY}px, 0) scale(${scaleX}, ${scaleY})`;
    }

    function getTargetRect(dimensions: { width: number; height: number }) {
      if (!lightboxContent) return null;
      const contentRect = lightboxContent.getBoundingClientRect();
      const styles = window.getComputedStyle(lightboxContent);
      const paddingX =
        Number.parseFloat(styles.paddingLeft) + Number.parseFloat(styles.paddingRight);
      const paddingY =
        Number.parseFloat(styles.paddingTop) + Number.parseFloat(styles.paddingBottom);
      const fallbackWidth = window.innerWidth;
      const fallbackHeight = window.innerHeight;
      const contentWidth = Math.max(
        0,
        (contentRect.width || fallbackWidth) - paddingX
      );
      const contentHeight = Math.max(
        0,
        (contentRect.height || fallbackHeight) - paddingY
      );
      const maxWidth = Math.min(contentWidth, 1400);
      const maxHeight = Math.min(contentHeight, window.innerHeight * 0.9, 860);
      const scale = Math.min(
        1,
        maxWidth / dimensions.width,
        maxHeight / dimensions.height
      );
      const width = Math.max(1, dimensions.width * scale);
      const height = Math.max(1, dimensions.height * scale);
      const left = contentRect.left + paddingX / 2 + (contentWidth - width) / 2;
      const top = contentRect.top + paddingY / 2 + (contentHeight - height) / 2;
      return {
        left,
        top,
        width,
        height,
      } as DOMRect;
    }

    function hideSourceImage(img: HTMLImageElement | null) {
      if (!img) return;
      if (img.dataset.lightboxHidden === 'true') return;
      img.dataset.lightboxHidden = 'true';
      img.dataset.lightboxVisibility = img.style.visibility || '';
      img.style.visibility = 'hidden';
    }

    function showSourceImage(img: HTMLImageElement | null) {
      if (!img) return;
      if (img.dataset.lightboxHidden !== 'true') return;
      img.style.visibility = img.dataset.lightboxVisibility || '';
      delete img.dataset.lightboxHidden;
      delete img.dataset.lightboxVisibility;
    }

    function lockScroll() {
      const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
      bodyPaddingRight = document.body.style.paddingRight || '';
      document.body.style.overflow = 'hidden';
      if (scrollbarWidth > 0) {
        document.body.style.paddingRight = `${scrollbarWidth}px`;
      }
    }

    function unlockScroll() {
      document.body.style.overflow = '';
      document.body.style.paddingRight = bodyPaddingRight;
      bodyPaddingRight = '';
    }

    function getImageDimensions(img: HTMLImageElement) {
      if (img.naturalWidth && img.naturalHeight) {
        return { width: img.naturalWidth, height: img.naturalHeight };
      }
      const rect = img.getBoundingClientRect();
      if (rect.width && rect.height) {
        return { width: rect.width, height: rect.height };
      }
      return null;
    }

    function clearPreview() {
      if (!lightboxImage) return;
      if (lightboxSource) {
        lightboxSource.removeAttribute('srcset');
      }
      lightboxImage.removeAttribute('src');
      lightboxImage.style.aspectRatio = '';
      lightboxImage.style.width = '';
      lightboxImage.style.height = '';
    }

    function waitForImageReady(img: HTMLImageElement, token: number) {
      if (token !== loadToken) return Promise.reject();
      if (img.complete && img.naturalWidth && img.naturalHeight) {
        return Promise.resolve(token);
      }
      if (img.decode) {
        return img.decode().then(() => token).catch(() => token);
      }
      return new Promise<number>((resolve) => {
        const finalize = () => resolve(token);
        img.addEventListener('load', finalize, { once: true });
        img.addEventListener('error', finalize, { once: true });
      });
    }

    function loadFullImage(img: HTMLImageElement, token: number) {
      if (!lightbox || !lightboxImage) return Promise.reject();
      if (token !== loadToken) return Promise.reject();
      const { webpSrc, jpgSrc } = getImageSources(img);
      if (lightboxSource) {
        if (webpSrc) {
          lightboxSource.srcset = webpSrc;
        } else {
          lightboxSource.removeAttribute('srcset');
        }
      }
      lightboxImage.src = jpgSrc;
      if (lightboxImage.decode) {
        return lightboxImage.decode().then(() => token).catch(() => token);
      }
      return new Promise<number>((resolve) => {
        const finalize = () => resolve(token);
        lightboxImage.addEventListener('load', finalize, { once: true });
        lightboxImage.addEventListener('error', finalize, { once: true });
      });
    }

    function getImageSources(img: HTMLImageElement) {
      const webpSrc = img.dataset.webpSrc || '';
      const jpgSrc = img.dataset.jpgSrc || img.src;
      return { webpSrc, jpgSrc };
    }

    function normalizeDate(value?: string | null) {
      if (!value) return '';
      const normalized = value.replace(/^(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3');
      const parsed = new Date(normalized);
      if (!Number.isNaN(parsed.getTime())) {
        return parsed.toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
      }
      return value;
    }

    function setSectionValue(sectionId: string, value?: string | null) {
      const section = document.querySelector(`[data-field="${sectionId}"]`);
      const valueEl = section?.querySelector('.lightbox-info-value');
      if (!section || !valueEl) return false;
      if (value && value.trim()) {
        valueEl.textContent = value;
        section.classList.remove('is-empty');
        return true;
      }
      valueEl.textContent = '';
      section.classList.add('is-empty');
      return false;
    }

    function hydrateInfo(img: HTMLImageElement) {
      const date = normalizeDate(img.dataset.exifDate);
      const location = img.dataset.exifLocation || '';
      const camera = img.dataset.exifCamera || '';
      const lens = img.dataset.exifLens || '';
      const focalLength = img.dataset.exifFocalLength || '';
      const aperture = img.dataset.exifAperture || '';
      const shutterSpeed = img.dataset.exifShutterSpeed || '';
      const iso = img.dataset.exifIso || '';
      const latitude = img.dataset.exifLatitude;
      const longitude = img.dataset.exifLongitude;

      if (lightboxDate) lightboxDate.textContent = date;
      if (lightboxLocation) lightboxLocation.textContent = location;
      if (lightboxHeader) {
        lightboxHeader.style.display = date || location ? 'flex' : 'none';
      }
      if (lightboxMapLabel) {
        lightboxMapLabel.textContent = location ? `Location â€“ ${location}` : 'Location';
      }

      const settingsParts = [focalLength, aperture, shutterSpeed, iso].filter(Boolean);
      const settings = settingsParts.join('  ');

      const hasCamera = setSectionValue('camera', camera);
      const hasLens = setSectionValue('lens', lens);
      const hasSettings = setSectionValue('settings', settings);

      const hasMap = hydrateMap(latitude, longitude);

      const hasAny =
        Boolean(date || location) || hasCamera || hasLens || hasSettings || hasMap;
      if (lightboxEmpty) {
        lightboxEmpty.classList.toggle('active', !hasAny);
      }
    }

    function hydrateMap(latitude?: string, longitude?: string) {
      if (!lightboxMapSection || !lightboxMap || !lightboxMapFrame) return false;
      if (!staticMapsKey || !latitude || !longitude) {
        lightboxMapSection.classList.add('is-empty');
        lightboxMapFrame.innerHTML = '';
        if (lightboxMapLink) lightboxMapLink.removeAttribute('href');
        return false;
      }
      const lat = Number.parseFloat(latitude);
      const lng = Number.parseFloat(longitude);
      if (Number.isNaN(lat) || Number.isNaN(lng)) {
        lightboxMapSection.classList.add('is-empty');
        lightboxMapFrame.innerHTML = '';
        if (lightboxMapLink) lightboxMapLink.removeAttribute('href');
        return false;
      }

      const staticMapUrl = new URL('https://maps.googleapis.com/maps/api/staticmap');
      staticMapUrl.searchParams.set('center', `${lat},${lng}`);
      staticMapUrl.searchParams.set('zoom', '14');
      const mapRect = lightboxMap.getBoundingClientRect();
      const mapWidth = Math.max(320, Math.min(640, Math.round(mapRect.width)));
      const mapHeight = Math.max(240, Math.min(640, Math.round(mapRect.height)));
      staticMapUrl.searchParams.set('size', `${mapWidth}x${mapHeight}`);
      staticMapUrl.searchParams.set('scale', '2');
      staticMapUrl.searchParams.set('maptype', 'roadmap');
      staticMapUrl.searchParams.set('markers', `color:red|${lat},${lng}`);
      staticMapUrl.searchParams.set('key', staticMapsKey);
      lightboxMapFrame.innerHTML = `<img alt="Photo location map" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${staticMapUrl.toString()}" srcset="${staticMapUrl.toString()} 2x" />`;
      if (lightboxMapLink) {
        const linkUrl = new URL('https://www.google.com/maps/search/');
        linkUrl.searchParams.set('api', '1');
        linkUrl.searchParams.set('query', `${lat},${lng}`);
        lightboxMapLink.href = linkUrl.toString();
      }
      lightboxMapSection.classList.remove('is-empty');
      return true;
    }

    function clearInfo() {
      if (lightboxDate) lightboxDate.textContent = '';
      if (lightboxLocation) lightboxLocation.textContent = '';
      if (lightboxHeader) lightboxHeader.style.display = '';
      setSectionValue('camera', '');
      setSectionValue('lens', '');
      setSectionValue('settings', '');
      if (lightboxMapSection) lightboxMapSection.classList.add('is-empty');
      if (lightboxMapFrame) lightboxMapFrame.innerHTML = '';
      if (lightboxMapLink) lightboxMapLink.removeAttribute('href');
      if (lightboxEmpty) lightboxEmpty.classList.remove('active');
    }
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLightbox);
  } else {
    initLightbox();
  }

  // Reinitialize after navigation (for Astro's View Transitions if used)
  document.addEventListener('astro:page-load', initLightbox);
</script>
