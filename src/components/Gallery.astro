---
import Lightbox from './Lightbox.astro';

interface Props {
  title: string;
  images: Array<{
    webpSrc: string;
    jpgSrc: string;
    alt: string;
    exif?: {
      date?: string;
      camera?: string;
      lens?: string;
      focalLength?: string;
      aperture?: string;
      shutterSpeed?: string;
      iso?: string;
      latitude?: number;
      longitude?: number;
      location?: string;
    };
  }>;
}

const { title, images } = Astro.props;
---

<div class="gallery-page">
  <div class="gallery-grid">
    {images.map((image) => (
      <div class="gallery-item">
        <picture>
          <source type="image/webp" srcset={image.webpSrc} />
          <img
            src={image.jpgSrc}
            alt={image.alt}
            loading="lazy"
            data-webp-src={image.webpSrc}
            data-jpg-src={image.jpgSrc}
            data-exif-date={image.exif?.date}
            data-exif-camera={image.exif?.camera}
            data-exif-lens={image.exif?.lens}
            data-exif-focal-length={image.exif?.focalLength}
            data-exif-aperture={image.exif?.aperture}
            data-exif-shutter-speed={image.exif?.shutterSpeed}
            data-exif-iso={image.exif?.iso}
            data-exif-latitude={image.exif?.latitude}
            data-exif-longitude={image.exif?.longitude}
            data-exif-location={image.exif?.location}
          />
        </picture>
      </div>
    ))}
  </div>
</div>

<Lightbox />

<script is:inline>
  const galleryGrid = document.querySelector('.gallery-grid');
  const galleryItems = galleryGrid ? Array.from(galleryGrid.querySelectorAll('.gallery-item')) : [];

  function classifyAspect(item) {
    const img = item.querySelector('img');
    if (!img || !img.naturalWidth || !img.naturalHeight) return;
    const ratio = img.naturalHeight / img.naturalWidth;
    if (ratio > 16 / 9) {
      item.dataset.aspect = 'tall';
    } else if (ratio < 9 / 16) {
      item.dataset.aspect = 'wide';
    } else {
      item.dataset.aspect = 'normal';
    }
  }

  function getColumnCount() {
    if (!galleryGrid) return 1;
    const style = window.getComputedStyle(galleryGrid);
    const count = Number.parseInt(style.columnCount, 10);
    return Number.isNaN(count) ? 1 : Math.max(1, count);
  }

  function findFirstRowItems(items) {
    const positions = items.map((item) => ({ item, top: item.getBoundingClientRect().top }));
    const minTop = Math.min(...positions.map((pos) => pos.top));
    const threshold = minTop + 4;
    return positions.filter((pos) => pos.top <= threshold).map((pos) => pos.item);
  }

  function reorderItems() {
    if (!galleryGrid || galleryItems.length === 0) return;
    const ordered = [...galleryItems];
    const maxPasses = Math.min(5, ordered.length);
    let pass = 0;

    while (pass < maxPasses) {
      ordered.forEach((item) => galleryGrid.appendChild(item));
      const firstRow = findFirstRowItems(ordered);
      let swapped = false;

      for (const rowItem of firstRow) {
        const aspect = rowItem.dataset.aspect;
        if (aspect === 'tall' || aspect === 'wide') {
          const swapIndex = ordered.findIndex(
            (candidate, index) =>
              index > ordered.indexOf(rowItem) && candidate.dataset.aspect === 'normal'
          );
          if (swapIndex !== -1) {
            const rowIndex = ordered.indexOf(rowItem);
            const tmp = ordered[rowIndex];
            ordered[rowIndex] = ordered[swapIndex];
            ordered[swapIndex] = tmp;
            swapped = true;
          }
        }
      }

      if (!swapped) break;
      pass += 1;
    }

    ordered.forEach((item) => galleryGrid.appendChild(item));
  }

  function initOrdering() {
    if (!galleryGrid || galleryItems.length === 0) return;
    galleryItems.forEach((item) => {
      const img = item.querySelector('img');
      if (!img) return;
      if (img.complete) {
        classifyAspect(item);
      } else {
        img.addEventListener('load', () => {
          classifyAspect(item);
          reorderItems();
        }, { once: true });
      }
    });
    reorderItems();
  }

  initOrdering();
  window.addEventListener('resize', () => {
    window.requestAnimationFrame(reorderItems);
  });
</script>

<style>
  .gallery-grid {
    --tile-gap: 0.25rem;
    column-gap: var(--tile-gap);
    column-count: 3;
    column-width: 280px;
    column-fill: balance;
    -webkit-column-fill: balance;
    margin-top: 0;
    font-size: 0;
  }

  .gallery-item {
    display: inline-block;
    width: 100%;
    vertical-align: top;
    -webkit-column-break-inside: avoid;
    break-inside: avoid;
    margin-bottom: var(--tile-gap);
    overflow: hidden;
    background: #f5f5f5;
    line-height: normal;
    transition: opacity 0.2s;
  }

  .gallery-item:hover {
    opacity: 0.9;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
  }

  @media (max-width: 1280px) {
    .gallery-grid {
      column-count: 2;
    }
  }

  @media (max-width: 768px) {
    .gallery-grid {
      column-count: 1;
      column-gap: var(--tile-gap);
    }
  }
</style>
