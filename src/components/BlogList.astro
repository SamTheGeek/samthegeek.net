---
import type { CollectionEntry } from 'astro:content';
import BlogPostFooter from './BlogPostFooter.astro';

interface Props {
  posts: CollectionEntry<'blog'>[];
  page: number;
  totalPages: number;
}

const { posts, page, totalPages } = Astro.props;

const formatDate = (date: Date): string =>
  new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);

const stripHtml = (html: string): string =>
  html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

const stripCaptions = (html: string): string =>
  html
    .replace(/<figcaption[\s\S]*?<\/figcaption>/gi, ' ')
    .replace(/<p[^>]*class=["'][^"']*image-caption[^"']*["'][\s\S]*?<\/p>/gi, ' ')
    .replace(/<div[^>]*class=["'][^"']*image-caption[^"']*["'][\s\S]*?<\/div>/gi, ' ');

const stripFigures = (html: string): string =>
  html
    .replace(/<figure[\s\S]*?<\/figure>/gi, ' ')
    .replace(/<img[^>]*>/gi, ' ')
    .replace(/<div[^>]*class=["'][^"']*sqs-block-image[^"']*["'][\s\S]*?<\/div>/gi, ' ');

const extractFirstEmbed = (html: string): string | null => {
  const iframeMatch = html.match(/<iframe[\s\S]*?<\/iframe>/i);
  if (iframeMatch) return iframeMatch[0];
  const embedMatch = html.match(/<div[^>]*class=["'][^"']*embed-block-wrapper[^"']*["'][\s\S]*?<\/div>/i);
  return embedMatch ? embedMatch[0] : null;
};

const buildExcerptHtml = (html: string, maxChars: number): string => {
  const embed = extractFirstEmbed(html);
  const cleaned = stripFigures(stripCaptions(html));
  const blocks = cleaned.match(/<(p|ul|ol|blockquote|h2|h3)[^>]*>[\s\S]*?<\/\1>/gi) ?? [];
  const picked: string[] = [];
  let count = 0;
  for (const block of blocks) {
    const text = stripHtml(block);
    if (!text) continue;
    picked.push(block);
    count += text.length;
    if (count >= maxChars) break;
  }
  if (picked.length) {
    return `${embed ? `<div class="feed-embed">${embed}</div>` : ''}${picked.join('')}`;
  }
  const fallback = stripHtml(cleaned);
  return `${embed ? `<div class="feed-embed">${embed}</div>` : ''}<p>${fallback.slice(0, maxChars).trim()}${fallback.length > maxChars ? 'â€¦' : ''}</p>`;
};

const extractLeadImage = (html: string) => {
  const match = html.match(/<img[^>]+src=["']([^"']+)["'][^>]*>/i);
  if (!match) return null;
  const altMatch = match[0].match(/alt=["']([^"']*)["']/i);
  return {
    src: match[1],
    alt: altMatch?.[1] ?? '',
  };
};

const buildCategoryLinks = (post: CollectionEntry<'blog'>) => {
  const categories = post.data.categories ?? (post.data.category ? [post.data.category] : []);
  return categories;
};

const hasPrev = page > 1;
const hasNext = page < totalPages;
const prevHref = page === 2 ? '/blog' : `/blog/page/${page - 1}`;
const nextHref = `/blog/page/${page + 1}`;

const buildViewTransitionId = (slug: string): string =>
  slug.toLowerCase().replace(/[^a-z0-9-_]/g, '-');
---

<div class="blog-page">
  <div class="article-list hfeed">
    {posts.map((post, index) => {
      const postHref = `/blog/${post.slug}`;
      const transitionId = buildViewTransitionId(post.slug);
      const categories = buildCategoryLinks(post);
      const renderedHtml = post.rendered?.html ?? '';
      return (
        <>
          <article class="hentry post-type-text">
            <header>
              <h1 class="entry-title" style={`view-transition-name: post-title-${transitionId};`}>
                <a href={postHref}>{post.data.title}</a>
              </h1>
              <div class="entry-info">
                <span class="published entry-date">
                  <time
                    datetime={post.data.pubDate.toISOString()}
                    style={`view-transition-name: post-date-${transitionId};`}
                  >
                    {formatDate(post.data.pubDate)}
                  </time>
                </span>
                {categories.length > 0 && (
                  <>
                    {' '}
                    in{' '}
                    <span class="category">
                      {categories.map((category, categoryIndex) => (
                        <>
                          <a href={`/blog/category/${encodeURIComponent(category)}`} rel="tag">
                            {category}
                          </a>
                          {categoryIndex < categories.length - 1 ? ',' : ''}
                          {categoryIndex < categories.length - 1 ? ' ' : ''}
                        </>
                      ))}
                    </span>
                  </>
                )}
              </div>
            </header>

            {(() => {
              const bodyHtml = renderedHtml
                || post.data.rssContent
                || post.data.rssDescription
                || post.body
                || '';
              const bodyLength = stripHtml(bodyHtml).length;
              const shouldExcerpt = bodyLength > 380;
              const leadImage = extractLeadImage(bodyHtml);
              if (!shouldExcerpt) {
                return <div class="body entry-content" set:html={bodyHtml} />;
              }
              const excerptSource = post.data.excerptHtml ?? post.data.rssDescription ?? bodyHtml;
              return (
                <div class="body entry-content">
                  {leadImage && (
                    <figure class="feed-lead">
                      <img
                        src={leadImage.src}
                        alt={leadImage.alt || post.data.title}
                        loading="lazy"
                      />
                    </figure>
                  )}
                  <div class="feed-excerpt" set:html={buildExcerptHtml(excerptSource, 520)} />
                  <a class="read-more" href={postHref}>
                    Read More
                  </a>
                </div>
              );
            })()}

            <BlogPostFooter post={post} postUrl={postHref} showTags={false} />
          </article>
          {index < posts.length - 1 && <div class="post-divider"></div>}
        </>
      );
    })}
  </div>

  {totalPages > 1 && (
    <nav class="pagination">
      {hasPrev ? <a href={prevHref}>Prev</a> : 'Prev'} /{' '}
      {hasNext ? <a href={nextHref}>Next</a> : 'Next'}
    </nav>
  )}
</div>
